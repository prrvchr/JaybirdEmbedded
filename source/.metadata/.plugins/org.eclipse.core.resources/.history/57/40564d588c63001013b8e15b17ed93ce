package io.github.prrvchr.firebird_5_0_3;

import java.util.Arrays;
import java.util.Collection;
import java.util.List;

import com.sun.jna.Platform;

import org.firebirdsql.jna.embedded.classpath.ClasspathFirebirdEmbeddedLibrary;
import org.firebirdsql.jna.embedded.classpath.ClasspathFirebirdEmbeddedResource;
import org.firebirdsql.jna.embedded.spi.FirebirdEmbeddedLoadingException;
import org.firebirdsql.jna.embedded.spi.FirebirdEmbeddedLibrary;

public class FirebirdEmbeddedProvider 
        implements org.firebirdsql.jna.embedded.spi.FirebirdEmbeddedProvider {

    private static final String SERVER_VERSION = "V5.0.3.16830 Firebird 5.0";

    @Override
    public String getPlatform() {
        //return "win32-x86-64";
        return Platform.RESOURCE_PREFIX;
    }

    @Override
    public String getVersion() {
        String prefix = null;
        switch (Platform.getOSType()) {
            case Platform.LINUX:
                prefix = "LI-";
                break;
            case Platform.WINDOWS:
                prefix = "WI-";
                break;
        }
        return prefix + SERVER_VERSION;
    }

    @Override
    public FirebirdEmbeddedLibrary getFirebirdEmbeddedLibrary() 
            throws FirebirdEmbeddedLoadingException {
        return ClasspathFirebirdEmbeddedLibrary.load(this, new ResourceInfo());
    }

    private static class ResourceInfo implements ClasspathFirebirdEmbeddedResource {

        @Override
        public String getLibraryEntryPoint() {
            String entry = null;
            switch (Platform.getOSType()) {
                case Platform.LINUX:
                    entry = "lib/libfbclient.so";
                    break;
                case Platform.WINDOWS:
                    entry = "fbclient.dll";
                    break;
            }
            return entry;
        }

        @Override
        public Collection<String> getResourceList() {
            List<String> resources = null;
            switch (Platform.getOSType()) {
                case Platform.LINUX:
                    resources = Arrays.asList(Platform.RESOURCE_PREFIX + "/intl/fbintl.conf",
                                              Platform.RESOURCE_PREFIX + "/intl/fbintl",
                                              Platform.RESOURCE_PREFIX + "/plugins/libEngine13.so",
                                              Platform.RESOURCE_PREFIX + "/plugins/udr_engine.conf",
                                              Platform.RESOURCE_PREFIX + "/plugins/libudr_engine.so",
                                              Platform.RESOURCE_PREFIX + "/lib/libfbclient.so",
                                              Platform.RESOURCE_PREFIX + "/lib/libib_util.so",
                                              Platform.RESOURCE_PREFIX + "/lib/libtomcrypt.so",
                                              Platform.RESOURCE_PREFIX + "/firebird.conf",
                                              Platform.RESOURCE_PREFIX + "/firebird.msg",
                                              Platform.RESOURCE_PREFIX + "/plugins.conf");
                    break;
                case Platform.WINDOWS:
                    resources = Arrays.asList(Platform.RESOURCE_PREFIX + "/intl/fbintl.conf",
                                              Platform.RESOURCE_PREFIX + "/intl/fbintl.dll",
                                              Platform.RESOURCE_PREFIX + "/plugins/engine13.dll",
                                              Platform.RESOURCE_PREFIX + "/plugins/udr_engine.conf",
                                              Platform.RESOURCE_PREFIX + "/plugins/udr_engine.dll",
                                              Platform.RESOURCE_PREFIX + "/fbclient.dll",
                                              Platform.RESOURCE_PREFIX + "/firebird.conf",
                                              Platform.RESOURCE_PREFIX + "/firebird.msg",
                                              Platform.RESOURCE_PREFIX + "/ib_util.dll",
                                              Platform.RESOURCE_PREFIX + "/icudt63.dll",
                                              Platform.RESOURCE_PREFIX + "/icudt63l.dat",
                                              Platform.RESOURCE_PREFIX + "/icuin63.dll",
                                              Platform.RESOURCE_PREFIX + "/icuuc63.dll",
                                              Platform.RESOURCE_PREFIX + "/plugins.conf");
                    break;
            }
            return resources;
        }
    }
}

